<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <link href="__static__/cssio/global.css" rel="stylesheet">
    <link href="__static__/cssio/login.css" rel="stylesheet">
    <script src="__static__/jsio/jquery.min.js"></script>
    <link href="__static__/cssio/toastr.min.css" rel="stylesheet">
    <script src="__static__/jsio/toastr.min.js"></script>
    <script src="__module__/layer/layer.js"></script>
    <link rel="stylesheet" href="__layui__/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="__layui__/layui/style/admin.css" media="all">

</head>
<body>
<div class="content of-login">
    <div class="login-main">
        <img alt="" class="right-msg" src="__static__/picture/login-banner.png">
        <form id="login" method="post">
            <div class="login-box">
                <img alt="" class="right-light" src="__static__/picture/login-light.png">
                <div class="of-header">用户登录</div>
                <input type="hidden" name="__token__" value="d26c59516978568f4a83df47cb2c94f7" />                <div class="flex-center-wrap flex-justify-between of-input ">
                <img alt="" src="__static__/picture/login-user.png">
                <input name="mobile"  id="mobile" placeholder="请输入手机号" type="text">
            </div>

                <div class="flex-center-wrap flex-justify-between of-input ">
                    <img alt="" src="__static__/picture/login-pass.png">
                    <input name="password"  id="password" placeholder="请输入密码" type="password">
                </div>

                <div class="of-forget" id="forget">忘记密码</div>
                <div class="of-pass-btn" onclick="login()">登 录</div>
                <div class="of-without">没有注册？<a href="{:url('Index/reg')}">注册</a></div>
            </div>
        </form>
    </div>
</div>

<div class="layui-row" id="popForget" style="display:none;">
    <div class="layui-col-md12">
        <form class="layui-form" action="" method="post" id="editProxy" style="margin-top:20px;margin-right: 20px;" >
            <!--<div class="layui-form-item">-->
            <!--<label class="layui-form-label">账号：</label>-->
            <!--<div class="layui-input-inline">-->
            <!--<input type="text" id="userNameForFind" name='userName'  placeholder="请输入账号" lay-verify="required" autocomplete="off" class="layui-input">-->
            <!--</div>-->
            <!--</div>-->
            <div class="layui-form-item">
                <label class="layui-form-label">手机号：</label>
                <div class="layui-input-inline">
                    <input type="text" id="phoneNumForFind" lay-verify="required" placeholder="请输入手机号" autocomplete="off" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">密码：</label>
                <div class="layui-input-inline">
                    <input type="password" id="passwordForFind" name='password' lay-verify="required" placeholder="请输入新密码" autocomplete="off" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">验证码：</label>
                <div class="layui-input-block">
                    <input style="width: 50%;float: left" type="text" id="codeForFind" name=".accountcode" lay-verify="required" placeholder="请输入验证码..." autocomplete="off" class="layui-input">
                    <button class="layui-btn layui-btn-normal sendCode"
                            id="sendcode" type="button" style="width:45%;float: right">发送验证码
                    </button>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label"></label>
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn layui-btn-radius"  id="setpassword">修改</button>
                    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius" id="edit_reset">重置</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script src="__static__/jsio/user.js"></script>
<script src="__layui__/layui/layui.js"></script>
<script src="__js__/jquery.min.js?v=2.1.4"></script>

<script src="__static__/js/cache.js"></script>
<script src="__static__/js/common.js"></script>
<script>
    layui.config({
        base: '/src/layuiadmin/' //静态资源所在路径
    }).use(['layer', 'form', 'jquery'],function () {
        var layer = layui.layer
            ,form = layui.form
            ,$    = layui.$;
        $(function() {

            $('#de111').width($('#item').width()*0.57);
            $('#de222').width($('#item').width()*0.41);
            //设置二维码宽高
            $('#capimg').width($('#item').width()*0.41).height($('#item').height());
            $('#de222').on('click', function() {
                $(this).html("<img src=\"{:url('login/verify')}?random="+Math.random()+"\" alt=\"captcha\" id='capimg'/>");
                $('#capimg').width($('#item').width()*0.41).height($('#item').height());
            });

            //登录
            $("#loginForm").submit(function () {
                cookie.clear();
                return true;
            });

            //忘记密码
            $('#forget').on('click', function() {
                showForget();
            });

            //发送短信验证码
            $('#sendcode').on('click', function() {
                sendCode();
            });
            $('#setpassword').on('click', function(e) {
                e.preventDefault();
                modifierPassword();
            })
        });

        function showForget() {
            index = layer.open({
                type: 1,
                title: '找回密码',
                shadeClose: true,
                shade: 0.8,
                content: $('#popForget')
            });
        }

        function sendCode() {
            var phoneNum = $('#phoneNumForFind').val();
            console.log(phoneNum);
            if (phoneNum === '') {
                layer.msg('手机号码不能为空');
                return false;
            }
            if (phoneNum.length<6) {
                layer.msg('手机号码格式不正确');
                return false;
            }

            $.ajax({
//                url: "{:url('login/sendCodeNoAuth')}",
                url: "{:url('sendcodecheck')}",
                type: 'get',
                data: {
                    mobile: phoneNum,
                    //captcha: captcha
                },
                success: function (response) {
//
//                    if (res.status === 0) {
//                    layer.msg('发送成功',{icon:1,time:1000});
////
//                    }else{
//                        layer.msg('发送失败',{icon:2,time:1000});
//                    }

                    if (response.status === 0) {
                        layer.msg('发送成功');
                        cache.setItem('loginCode', phoneNum);
                        cache.createTimeOut();
                    } else if (response.status === 2){
                        layer.msg(response.msg,{icon:2,time:1000}, function () {
                            window.location.href="{:url('index/index/reg')}";
                        });
                    }else{
                        layer.msg(response.msg)
                    }
                }
            })
        }


        function modifierPassword() {
            var password=$('#passwordForFind').val();
            if(password.length<6){
                layer.msg('密码长度必须大于6位');
                return false;
            }
            $.ajax({
//                url: "{:url('login/findPassword')}",
                url: "{:url('findPassword')}",
                type: 'post',
                beforeSend: function (request) {
                    // request.setRequestHeader(header, token);
                },
                data: {
//                    userName: $('#userNameForFind').val(),
                    password: $('#passwordForFind').val(),
                    phone: $('#phoneNumForFind').val(),
                    code: $('#codeForFind').val(),
                    //captcha: $('#captcha2').val()
                },
                success: function (response) {
                    if (response.status== 0 ) {
                        layer.msg('密码修改成功，请登录！',{icon:1,time:1000}, function () {
                            window.location.href="{:url('index/index/index')}";
                        });
                    } else {
                        layer.msg(response.msg,{icon:2,time:1000}, function () {
                            window.location.href="{:url('index/index/index')}";
                        });
                    }
                }, complete: function (xhr) {
                    console.log(xhr)
                }

            })
        }

    })
</script>
</body>
<script >
    //忘记密码
    $('#forget').on('click', function() {
        function showForget() {
            index = layer.open({
                type: 1,
                title: '找回密码',
                shadeClose: true,
                shade: 0.8,
                content: $('#popForget')
            });
        }
    });
    function login(){
//        var username  = $('#username').val();
        var password  = $('#password').val();
        var mobile  = $('#mobile').val();


//        var code_  = $('#J_codetext').val();

//        var remember = [];
//        $('input[name="remember"]:checked').each(function(){
//            remember.push($(this).val());
//        });
//        var sr = 0;
//        if (remember[0] === 'on') {
//            sr = 1;
//        }
//        console.log(sr);
        if ( password=='') {
            layer.msg('密码不能为空', {offset:'t'}  );
            return;
        }
        if (mobile == '') {
            layer.msg('账号不能为空', {offset:'t'}  );
            return;
        }
//        if(code_==''||code_==null){
//            layer.msg('验证码不能为空', {offset:'t'}  );
//            return;
//        }
//        var vali = validate();
//        if (!vali) {
//            layer.msg('验证码错误，请重新输入',{});
//            createCode();
//            return false;
//        }


        $.ajax({
            type:'post',
//            url:'login',
            url: "{:url('login')}",
            data:{
//                username: username,
                password:password,
                mobile:mobile,
//                remember:sr
            },
            dataType:'json',
            success: function(res) {
                if (res.code === 0) {
                    layer.msg('登录成功',{icon:1,time:1000}, function () {
                        window.location.href="{:url('index/index/content')}";
                    });
                } else if (res.code === 1) {
                    window.location.href="{:url('index/index/index')}";
                } else if (res.code === 2) {
                    window.location.href="{:url('index/index/index')}";
                }else if (res.code === 3) {
                    layer.msg(res.msg,{icon:2,time:1000}, function () {

                    });

                }
            }
        });
    }
</script>
</html>